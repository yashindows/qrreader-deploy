<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>qrreader</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css"
      integrity="sha512-2SwdPD6INVrV/lHTZbO2nodKhrnDdJK9/kg2XD1r9uGqPo1cUbujc+IYdlYdEErWNu69gVcYgdxlmVmzTWnetw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      .wrapper {
        display: flex;
        height: 100dvh;
        width: 100vw;
        justify-content: center;
      }
      #video,
      form {
        display: none;
      }
      .wrapper > * {
        align-self: center;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue",
          sans-serif;
        font-size: 30px;
      }
      #video {
        position: fixed;
        right: 0;
        left: 0;
        min-width: 100%;
        min-height: 100%;
      }
      button {
        background-color: transparent;
        border: none;
        padding: 15px;
        border-radius: 15px;
        font-weight: 600;
        box-shadow: 1px 1px 5px #333333c7;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <button onClick="startScanner()">
        Сканировать
        <i class="fa-solid fa-qrcode"></i>
      </button>
      <video id="video" autoplay></video>
      <form method="post" action="/add-data" id="result">
        <input type="hidden" name="name" />
        <input type="hidden" name="thing" />
        <input type="hidden" name="num" />
        <input type="hidden" name="date" />
      </form>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@zxing/library@latest/umd/index.min.js"></script>
    <script>
      const video = document.getElementById("video");
      const resultElement = document.getElementById("result");
      let reader;
      const btn = document.querySelector("button");
      async function startScanner() {
        video.style.display = "block";
        btn.style.display = "none";
        reader = new ZXing.BrowserQRCodeReader();
        const formats = [ZXing.BarcodeFormat.QR_CODE];
        const hints = new Map();
        hints.set(ZXing.DecodeHintType.POSSIBLE_FORMATS, formats);
        const qrData = {
          name: "",
          thing: "",
          num: "",
          date: "",
        };
        try {
          await reader.decodeFromVideoDevice(
            undefined,
            "video",
            (result, err) => {
              if (result) {
                const newString = result.text.split(/[:;\n\r]+/);
                if (newString.length == 8) {
                  resultElement.name.value = newString[1];
                  resultElement.thing.value = newString[3];
                  resultElement.num.value = newString[5];
                  resultElement.date.value = newString[7];

                  resultElement.submit();
                  reader.reset();
                } else {
                  reader.reset();
                  document.querySelector(".wrapper").innerHTML =
                    "<div class='result'>Ошибка структуры qr-кода</div>";
                }
              } else if (err && !(err instanceof ZXing.NotFoundException)) {
                console.error("Ошибка сканирования:", err);
              }
            }
          );
        } catch (error) {
          console.error("Не удалось получить доступ к камере:", error);
          resultElement.textContent =
            "Не удалось получить доступ к камере. Пожалуйста, дайте разрешение.";
        }
      }

      // window.addEventListener("load", startScanner);

      //   const data = {
      //     name: "ФИО",
      //     thing: "чтогоооо",
      //     num: 121233,
      //     date: new Date().toLocaleTimeString(),
      //   };

      //   resultElement.name.value = data.name;
      //   resultElement.thing.value = data.thing;
      //   resultElement.num.value = data.num;
      //   resultElement.date.value = data.date;

      // resultElement.submit();
    </script>
  </body>
</html>
